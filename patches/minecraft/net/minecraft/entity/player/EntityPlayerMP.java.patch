--- ../src-base/minecraft/net/minecraft/entity/player/EntityPlayerMP.java
+++ ../src-work/minecraft/net/minecraft/entity/player/EntityPlayerMP.java
@@ -79,12 +79,14 @@
 import net.minecraft.tileentity.TileEntity;
 import net.minecraft.tileentity.TileEntityCommandBlock;
 import net.minecraft.tileentity.TileEntitySign;
+import net.minecraft.util.CombatTracker;
 import net.minecraft.util.CooldownTracker;
 import net.minecraft.util.CooldownTrackerServer;
 import net.minecraft.util.DamageSource;
 import net.minecraft.util.EntityDamageSource;
 import net.minecraft.util.EnumHand;
 import net.minecraft.util.EnumHandSide;
+import net.minecraft.util.FoodStats;
 import net.minecraft.util.JsonSerializableSet;
 import net.minecraft.util.ReportedException;
 import net.minecraft.util.SoundCategory;
@@ -97,6 +99,7 @@
 import net.minecraft.village.MerchantRecipeList;
 import net.minecraft.world.IInteractionObject;
 import net.minecraft.world.ILockableContainer;
+import net.minecraft.world.World;
 import net.minecraft.world.WorldServer;
 import net.minecraft.world.WorldSettings;
 import net.minecraft.world.biome.Biome;
@@ -104,6 +107,24 @@
 import org.apache.logging.log4j.LogManager;
 import org.apache.logging.log4j.Logger;
 
+import org.bukkit.Bukkit;
+import org.bukkit.WeatherType;
+import org.bukkit.craftbukkit.CraftWorld;
+import org.bukkit.craftbukkit.entity.CraftPlayer;
+
+// CraftBukkit start
+import org.bukkit.Bukkit;
+import org.bukkit.WeatherType;
+import org.bukkit.craftbukkit.CraftWorld;
+import org.bukkit.craftbukkit.entity.CraftPlayer;
+import org.bukkit.craftbukkit.event.CraftEventFactory;
+import org.bukkit.craftbukkit.inventory.CraftItemStack;
+import org.bukkit.event.inventory.InventoryType;
+import org.bukkit.event.player.PlayerChangedMainHandEvent;
+import org.bukkit.event.player.PlayerTeleportEvent.TeleportCause;
+import org.bukkit.inventory.MainHand;
+// CraftBukkit end
+
 public class EntityPlayerMP extends EntityPlayer implements IContainerListener
 {
     private static final Logger field_147102_bM = LogManager.getLogger();
@@ -124,8 +145,8 @@
     private float field_71149_ch = -1.0E8F;
     private int field_71146_ci = -99999999;
     private boolean field_71147_cj = true;
-    private int field_71144_ck = -99999999;
-    private int field_147101_bU = 60;
+    public int field_71144_ck = -99999999;
+    public int field_147101_bU = 60;
     private EntityPlayer.EnumChatVisibility field_71143_cn;
     private boolean field_71140_co = true;
     private long field_143005_bX = System.currentTimeMillis();
@@ -135,6 +156,18 @@
     public boolean field_71137_h;
     public int field_71138_i;
     public boolean field_71136_j;
+    
+    // CraftBukkit start
+    public String displayName;
+    public ITextComponent listName;
+    public org.bukkit.Location compassTarget;
+    public int newExp = 0;
+    public int newLevel = 0;
+    public int newTotalExp = 0;
+    public boolean keepLevel = false;
+    public double maxHealthCache;
+    public boolean joining = true;
+    // CraftBukkit end
 
     @SuppressWarnings("unused")
     public EntityPlayerMP(MinecraftServer p_i45285_1_, WorldServer p_i45285_2_, GameProfile p_i45285_3_, PlayerInteractionManager p_i45285_4_)
@@ -171,6 +204,12 @@
         {
             this.func_70107_b(this.field_70165_t, this.field_70163_u + 1.0D, this.field_70161_v);
         }
+        
+        // CraftBukkit start
+        this.displayName = this.func_70005_c_();
+        // this.canPickUpLoot = true; TODO
+        this.maxHealthCache = this.func_110138_aP();
+        // CraftBukkit end
     }
 
     public void func_70037_a(NBTTagCompound p_70037_1_)
@@ -188,6 +227,7 @@
                 this.field_71134_c.func_73076_a(WorldSettings.GameType.func_77146_a(p_70037_1_.func_74762_e("playerGameType")));
             }
         }
+        this.getBukkitEntity().readExtraData(p_70037_1_); // CraftBukkit
     }
 
     public void func_70014_b(NBTTagCompound p_70014_1_)
@@ -205,7 +245,34 @@
             nbttagcompound.func_74782_a("Entity", nbttagcompound1);
             p_70014_1_.func_74782_a("RootVehicle", nbttagcompound);
         }
+        
+        this.getBukkitEntity().setExtraData(p_70014_1_); // CraftBukkit
     }
+    
+    // CraftBukkit start - World fallback code, either respawn location or global spawn
+    public void func_70029_a(World world) {
+    	super.func_70029_a(world);
+    	if (world == null) {
+    		this.field_70729_aU = false;
+    		BlockPos position = null;
+    		if (this.spawnWorld != null && !this.spawnWorld.equals("")) {
+    			CraftWorld cworld = (CraftWorld) Bukkit.getServer().getWorld(this.spawnWorld);
+    			if (cworld != null && this.func_180470_cg() != null) {
+    				world = cworld.getHandle();
+    				position = EntityPlayer.func_180467_a(cworld.getHandle(), this.func_180470_cg(), false);
+    			}
+    		}
+    		if (world == null || position == null) {
+    			world = ((CraftWorld) Bukkit.getServer().getWorlds().get(0)).getHandle();
+    			position = world.func_175694_M();
+    		}
+    		this.field_70170_p = world;
+    		this.func_70107_b(position.func_177958_n() + 0.5, position.func_177956_o(), position.func_177952_p() + 0.5);
+    	}
+    	this.field_71093_bK = ((WorldServer) this.field_70170_p).dimension;
+    	this.field_71134_c.func_73080_a((WorldServer) world);
+    }
+    // CraftBukkit end
 
     public void func_82242_a(int p_82242_1_)
     {
@@ -243,6 +310,12 @@
 
     public void func_70071_h_()
     {
+    	// CraftBukkit start
+    	if (this.joining) {
+    		this.joining = false;
+    	}
+    	// CraftBukkit end
+    	
         this.field_71134_c.func_73075_a();
         --this.field_147101_bU;
 
@@ -738,9 +811,10 @@
         this.field_71135_a.func_147359_a(new SPacketSignEditorOpen(p_175141_1_.func_174877_v()));
     }
 
-    public void func_71117_bO()
+    public int getNextWindowId() // CraftBukkit - void -> int
     {
         this.field_71139_cq = this.field_71139_cq % 100 + 1;
+        return field_71139_cq; // CraftBukkit
     }
 
     public void func_180468_a(IInteractionObject p_180468_1_)
@@ -751,7 +825,7 @@
         }
         else
         {
-            this.func_71117_bO();
+            this.getNextWindowId();
             this.field_71135_a.func_147359_a(new SPacketOpenWindow(this.field_71139_cq, p_180468_1_.func_174875_k(), p_180468_1_.func_145748_c_()));
             this.field_71070_bA = p_180468_1_.func_174876_a(this.field_71071_by, this);
             this.field_71070_bA.field_75152_c = this.field_71139_cq;
@@ -784,7 +858,7 @@
                 }
             }
 
-            this.func_71117_bO();
+            this.getNextWindowId();
 
             if (p_71007_1_ instanceof IInteractionObject)
             {
@@ -804,7 +878,7 @@
 
     public void func_180472_a(IMerchant p_180472_1_)
     {
-        this.func_71117_bO();
+        this.getNextWindowId();
         this.field_71070_bA = new ContainerMerchant(this.field_71071_by, p_180472_1_, this.field_70170_p);
         this.field_71070_bA.field_75152_c = this.field_71139_cq;
         this.field_71070_bA.func_75132_a(this);
@@ -829,7 +903,7 @@
             this.func_71053_j();
         }
 
-        this.func_71117_bO();
+        this.getNextWindowId();
         this.field_71135_a.func_147359_a(new SPacketOpenWindow(this.field_71139_cq, "EntityHorse", p_184826_2_.func_145748_c_(), p_184826_2_.func_70302_i_(), p_184826_1_.func_145782_y()));
         this.field_71070_bA = new ContainerHorseInventory(this.field_71071_by, p_184826_2_, p_184826_1_, this);
         this.field_71070_bA.field_75152_c = this.field_71139_cq;
@@ -987,6 +1061,14 @@
     {
         this.field_71149_ch = -1.0E8F;
     }
+    
+    // CraftBukkit start - Support multi-line messages
+    public void sendMessage(ITextComponent[] ichatbasecomponent) {
+    	for (ITextComponent component : ichatbasecomponent) {
+    		this.func_145747_a(component);
+    	}
+    }
+    // CraftBukkit end
 
     public void func_146105_b(ITextComponent p_146105_1_)
     {
@@ -1263,4 +1345,134 @@
         this.func_70052_a(7, true);
         this.func_70052_a(7, false);
     }
+    
+	// CraftBukkit start - Add per-player time and weather.
+	public long timeOffset = 0;
+	public boolean relativeTime = true;
+
+	public long getPlayerTime() {
+		if (this.relativeTime) {
+			// Adds timeOffset to the current server time.
+			return this.field_70170_p.func_72820_D() + this.timeOffset;
+		}
+		else {
+			// Adds timeOffset to the beginning of this day.
+			return this.field_70170_p.func_72820_D() - (this.field_70170_p.func_72820_D() % 24000) + this.timeOffset;
+		}
+	}
+
+	public WeatherType weather = null;
+
+	public WeatherType getPlayerWeather() {
+		return this.weather;
+	}
+
+	public void setPlayerWeather(WeatherType type, boolean plugin) {
+		if (!plugin && this.weather != null) {
+			return;
+		}
+
+		if (plugin) {
+			this.weather = type;
+		}
+
+		if (type == WeatherType.DOWNFALL) {
+			this.field_71135_a.func_147359_a(new SPacketChangeGameState(2, 0));
+		}
+		else {
+			this.field_71135_a.func_147359_a(new SPacketChangeGameState(1, 0));
+		}
+	}
+
+	private float pluginRainPosition;
+	private float pluginRainPositionPrevious;
+
+	public void updateWeather(float oldRain, float newRain, float oldThunder, float newThunder) {
+		if (this.weather == null) {
+			// Vanilla
+			if (oldRain != newRain) {
+				this.field_71135_a.func_147359_a(new SPacketChangeGameState(7, newRain));
+			}
+		}
+		else {
+			// Plugin
+			if (pluginRainPositionPrevious != pluginRainPosition) {
+				this.field_71135_a.func_147359_a(new SPacketChangeGameState(7, pluginRainPosition));
+			}
+		}
+
+		if (oldThunder != newThunder) {
+			if (weather == WeatherType.DOWNFALL || weather == null) {
+				this.field_71135_a.func_147359_a(new SPacketChangeGameState(8, newThunder));
+			}
+			else {
+				this.field_71135_a.func_147359_a(new SPacketChangeGameState(8, 0));
+			}
+		}
+	}
+
+	public void tickWeather() {
+		if (this.weather == null)
+			return;
+
+		pluginRainPositionPrevious = pluginRainPosition;
+		if (weather == WeatherType.DOWNFALL) {
+			pluginRainPosition += 0.01;
+		}
+		else {
+			pluginRainPosition -= 0.01;
+		}
+
+		pluginRainPosition = MathHelper.func_76131_a(pluginRainPosition, 0.0F, 1.0F);
+	}
+
+	public void resetPlayerWeather() {
+		this.weather = null;
+		this.setPlayerWeather(this.field_70170_p.func_72912_H().func_76059_o() ? WeatherType.DOWNFALL : WeatherType.CLEAR, false);
+	}
+
+	@Override
+	public String toString() {
+		return super.toString() + "(" + this.func_70005_c_() + " at " + this.field_70165_t + "," + this.field_70163_u + "," + this.field_70161_v + ")";
+	}
+
+	public void reset() {
+		float exp = 0;
+		boolean keepInventory = this.field_70170_p.func_82736_K().func_82766_b("keepInventory");
+
+		if (this.keepLevel || keepInventory) {
+			exp = this.field_71106_cc;
+			this.newTotalExp = this.field_71067_cb;
+			this.newLevel = this.field_71068_ca;
+		}
+
+		this.func_70606_j(this.func_110138_aP());
+		this.field_70720_be = 0;
+		this.field_70143_R = 0;
+		this.field_71100_bB = new FoodStats(this);
+		this.field_71068_ca = this.newLevel;
+		this.field_71067_cb = this.newTotalExp;
+		this.field_71106_cc = 0;
+		this.field_70725_aQ = 0;
+		this.func_70674_bp();
+		this.field_70752_e = true;
+		this.field_71070_bA = this.field_71069_bz;
+		this.field_70717_bb = null;
+		//this.flyToggleTimer = null;
+		//this.MAIN_HAND = new CombatTracker(this);
+		this.field_71144_ck = -1;
+		if (this.keepLevel || keepInventory) {
+			this.field_71106_cc = exp;
+		}
+		else {
+			this.func_71023_q(this.newExp);
+		}
+		this.keepLevel = false;
+	}
+
+	@Override
+	public CraftPlayer getBukkitEntity() {
+		return (CraftPlayer) super.getBukkitEntity();
+	}
+	// CraftBukkit end
 }
