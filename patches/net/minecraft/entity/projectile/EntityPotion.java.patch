--- ../src-base/minecraft/net/minecraft/entity/projectile/EntityPotion.java
+++ ../src-work/minecraft/net/minecraft/entity/projectile/EntityPotion.java
@@ -5,6 +5,7 @@
 import javax.annotation.Nullable;
 import net.minecraft.entity.EntityAreaEffectCloud;
 import net.minecraft.entity.EntityLivingBase;
+import net.minecraft.entity.player.EntityPlayerMP;
 import net.minecraft.init.Blocks;
 import net.minecraft.init.Items;
 import net.minecraft.init.PotionTypes;
@@ -27,7 +28,21 @@
 import net.minecraft.world.World;
 import org.apache.logging.log4j.LogManager;
 import org.apache.logging.log4j.Logger;
+import java.util.HashMap;
+import org.bukkit.craftbukkit.entity.CraftLivingEntity;
+import org.bukkit.craftbukkit.event.CraftEventFactory;
+import org.bukkit.entity.LivingEntity;
+import org.bukkit.event.entity.PotionSplashEvent;
 
+//CraftBukkit start
+import java.util.HashMap;
+
+import org.bukkit.craftbukkit.entity.CraftLivingEntity;
+import org.bukkit.craftbukkit.event.CraftEventFactory;
+import org.bukkit.entity.LivingEntity;
+// CraftBukkit end
+import org.bukkit.event.entity.PotionSplashEvent;
+
 public class EntityPotion extends EntityThrowable
 {
     private static final DataParameter<Optional<ItemStack>> field_184545_d = EntityDataManager.<Optional<ItemStack>>func_187226_a(EntityPotion.class, DataSerializers.field_187196_f);
@@ -112,11 +127,12 @@
             }
             else
             {
-                if (!list.isEmpty())
+                if (true/* || !list.isEmpty()*/)
                 {
                     if (this.func_184544_n())
                     {
                         EntityAreaEffectCloud entityareaeffectcloud = new EntityAreaEffectCloud(this.field_70170_p, this.field_70165_t, this.field_70163_u, this.field_70161_v);
+                        entityareaeffectcloud.projectileSource = this.projectileSource;
                         entityareaeffectcloud.func_184481_a(this.func_85052_h());
                         entityareaeffectcloud.func_184483_a(3.0F);
                         entityareaeffectcloud.func_184495_b(-0.5F);
@@ -129,45 +145,53 @@
                             entityareaeffectcloud.func_184496_a(new PotionEffect(potioneffect.func_188419_a(), potioneffect.func_76459_b(), potioneffect.func_76458_c()));
                         }
 
-                        this.field_70170_p.func_72838_d(entityareaeffectcloud);
+                        //this.worldObj.spawnEntityInWorld(entityareaeffectcloud);
+                        // CraftBukkit start
+                        org.bukkit.event.entity.LingeringPotionSplashEvent event = org.bukkit.craftbukkit.event.CraftEventFactory.callLingeringPotionSplashEvent(this, entityareaeffectcloud);
+                        if (!(event.isCancelled() || entityareaeffectcloud.field_70128_L)) {
+                        	this.field_70170_p.func_72838_d(entityareaeffectcloud);
+                        } else {
+                        	entityareaeffectcloud.field_70128_L = true;
+                        }
+                        // CraftBukkit end
                     }
                     else
                     {
-                        AxisAlignedBB axisalignedbb = this.func_174813_aQ().func_72314_b(4.0D, 2.0D, 4.0D);
-                        List<EntityLivingBase> list1 = this.field_70170_p.<EntityLivingBase>func_72872_a(EntityLivingBase.class, axisalignedbb);
+                        /*AxisAlignedBB axisalignedbb = this.getEntityBoundingBox().expand(4.0D, 2.0D, 4.0D);
+                        List<EntityLivingBase> list1 = this.worldObj.<EntityLivingBase>getEntitiesWithinAABB(EntityLivingBase.class, axisalignedbb);
 
                         if (!list1.isEmpty())
                         {
                             for (EntityLivingBase entitylivingbase : list1)
                             {
-                                if (entitylivingbase.func_184603_cC())
+                                if (entitylivingbase.canBeHitWithPotion())
                                 {
-                                    double d0 = this.func_70068_e(entitylivingbase);
+                                    double d0 = this.getDistanceSqToEntity(entitylivingbase);
 
                                     if (d0 < 16.0D)
                                     {
                                         double d1 = 1.0D - Math.sqrt(d0) / 4.0D;
 
-                                        if (entitylivingbase == p_70184_1_.field_72308_g)
+                                        if (entitylivingbase == result.entityHit)
                                         {
                                             d1 = 1.0D;
                                         }
 
                                         for (PotionEffect potioneffect1 : list)
                                         {
-                                            Potion potion = potioneffect1.func_188419_a();
+                                            Potion potion = potioneffect1.getPotion();
 
-                                            if (potion.func_76403_b())
+                                            if (potion.isInstant())
                                             {
-                                                potion.func_180793_a(this, this.func_85052_h(), entitylivingbase, potioneffect1.func_76458_c(), d1);
+                                                potion.affectEntity(this, this.getThrower(), entitylivingbase, potioneffect1.getAmplifier(), d1);
                                             }
                                             else
                                             {
-                                                int i = (int)(d1 * (double)potioneffect1.func_76459_b() + 0.5D);
+                                                int i = (int)(d1 * (double)potioneffect1.getDuration() + 0.5D);
 
                                                 if (i > 20)
                                                 {
-                                                    entitylivingbase.func_70690_d(new PotionEffect(potion, i, potioneffect1.func_76458_c()));
+                                                    entitylivingbase.addPotionEffect(new PotionEffect(potion, i, potioneffect1.getAmplifier()));
                                                 }
                                             }
                                         }
@@ -175,16 +199,66 @@
                                 }
                             }
                         }
+                    }*/
+                    	final AxisAlignedBB axisalignedbb = this.func_174813_aQ().func_72314_b(4.0, 2.0, 4.0);
+                        final List<EntityLivingBase> list2 = this.field_70170_p.func_72872_a(/*(Class<? extends Entity>)*/EntityLivingBase.class, axisalignedbb);
+                        final HashMap<LivingEntity, Double> affected = new HashMap<LivingEntity, Double>();
+                        if (!list2.isEmpty()) {
+                            for (final EntityLivingBase entityliving : list2) {
+                                if (entityliving.func_184603_cC()) {
+                                    final double d0 = this.func_70068_e(entityliving);
+                                    if (d0 >= 16.0) {
+                                        continue;
+                                    }
+                                    double d2 = 1.0 - Math.sqrt(d0) / 4.0;
+                                    if (entityliving == p_70184_1_.field_72308_g) {
+                                        d2 = 1.0;
+                                    }
+                                    affected.put((LivingEntity)entityliving.getBukkitEntity(), d2);
+                                }
+                            }
+                        }
+                        final PotionSplashEvent event2 = CraftEventFactory.callPotionSplashEvent(this, affected);
+                        if (!event2.isCancelled() && list != null && !list.isEmpty()) {
+                            for (final LivingEntity victim : event2.getAffectedEntities()) {
+                                if (!(victim instanceof CraftLivingEntity)) {
+                                    continue;
+                                }
+                                final EntityLivingBase entityliving2 = ((CraftLivingEntity)victim).getHandle();
+                                final double d2 = event2.getIntensity(victim);
+                                for (final PotionEffect mobeffect2 : list) {
+                                    final Potion mobeffectlist = mobeffect2.func_188419_a();
+                                    if (!this.field_70170_p.pvpMode && this.func_85052_h() instanceof EntityPlayerMP && entityliving2 instanceof EntityPlayerMP && entityliving2 != this.func_85052_h()) {
+                                        final int i = Potion.func_188409_a(mobeffectlist);
+                                        if (i == 2 || i == 4 || i == 7 || i == 15 || i == 17 || i == 18) {
+                                            continue;
+                                        }
+                                        if (i == 19) {
+                                            continue;
+                                        }
+                                    }
+                                    if (mobeffectlist.func_76403_b()) {
+                                        mobeffectlist.func_180793_a(this, this.func_85052_h(), entityliving2, mobeffect2.func_76458_c(), d2);
+                                    }
+                                    else {
+                                        final int i = (int)(d2 * mobeffect2.func_76459_b() + 0.5);
+                                        if (i <= 20) {
+                                            continue;
+                                        }
+                                        entityliving2.func_70690_d(new PotionEffect(mobeffectlist, i, mobeffect2.func_76458_c()));
+                                    }
+                                }
+                            }
+                        }
                     }
                 }
-
-                this.field_70170_p.func_175718_b(2002, new BlockPos(this), PotionType.func_185171_a(potiontype));
-                this.func_70106_y();
             }
+            this.field_70170_p.func_175718_b(2002, new BlockPos(this), PotionType.func_185171_a(potiontype));
+            this.func_70106_y();
         }
     }
 
-    private boolean func_184544_n()
+    public boolean func_184544_n()
     {
         return this.func_184543_l().func_77973_b() == Items.field_185156_bI;
     }
@@ -193,6 +267,7 @@
     {
         if (this.field_70170_p.func_180495_p(p_184542_1_).func_177230_c() == Blocks.field_150480_ab)
         {
+        	if (org.bukkit.craftbukkit.event.CraftEventFactory.callEntityChangeBlockEvent(this, p_184542_1_, Blocks.field_150350_a, 0).isCancelled()) return; // CraftBukkit
             this.field_70170_p.func_180501_a(p_184542_1_, Blocks.field_150350_a.func_176223_P(), 2);
         }
     }
