--- ../src-base/minecraft/net/minecraft/entity/player/EntityPlayerMP.java
+++ ../src-work/minecraft/net/minecraft/entity/player/EntityPlayerMP.java
@@ -101,9 +101,26 @@
 import net.minecraft.world.WorldServer;
 import net.minecraft.world.biome.Biome;
 import net.minecraft.world.storage.loot.ILootContainer;
+import ru.svarka.inventory.CBContainer;
+
 import org.apache.logging.log4j.LogManager;
 import org.apache.logging.log4j.Logger;
+import org.bukkit.craftbukkit.entity.CraftPlayer;
+import org.bukkit.WeatherType;
 
+//CraftBukkit start
+import org.bukkit.Bukkit;
+import org.bukkit.WeatherType;
+import org.bukkit.craftbukkit.CraftWorld;
+import org.bukkit.craftbukkit.entity.CraftPlayer;
+import org.bukkit.craftbukkit.event.CraftEventFactory;
+import org.bukkit.craftbukkit.inventory.CraftItemStack;
+import org.bukkit.event.inventory.InventoryType;
+import org.bukkit.event.player.PlayerChangedMainHandEvent;
+import org.bukkit.event.player.PlayerTeleportEvent.TeleportCause;
+import org.bukkit.inventory.MainHand;
+// CraftBukkit end
+
 public class EntityPlayerMP extends EntityPlayer implements IContainerListener
 {
     private static final Logger field_147102_bM = LogManager.getLogger();
@@ -124,17 +141,28 @@
     private float field_71149_ch = -1.0E8F;
     private int field_71146_ci = -99999999;
     private boolean field_71147_cj = true;
-    private int field_71144_ck = -99999999;
-    private int field_147101_bU = 60;
+    public int field_71144_ck = -99999999;
+    public int field_147101_bU = 60;
     private EntityPlayer.EnumChatVisibility field_71143_cn;
     private boolean field_71140_co = true;
     private long field_143005_bX = System.currentTimeMillis();
     private Entity field_175401_bS;
-    private boolean field_184851_cj;
+    public boolean field_184851_cj;
     public int field_71139_cq;
     public boolean field_71137_h;
     public int field_71138_i;
     public boolean field_71136_j;
+    // CraftBukkit start
+    public String displayName;
+    public ITextComponent listName;
+    public org.bukkit.Location compassTarget;
+    public int newExp = 0;
+    public int newLevel = 0;
+    public int newTotalExp = 0;
+    public boolean keepLevel = false;
+    public double maxHealthCache;
+    public boolean joining = true;
+    // CraftBukkit end
 
     @SuppressWarnings("unused")
     public EntityPlayerMP(MinecraftServer p_i45285_1_, WorldServer p_i45285_2_, GameProfile p_i45285_3_, PlayerInteractionManager p_i45285_4_)
@@ -742,6 +770,10 @@
     {
         this.field_71139_cq = this.field_71139_cq % 100 + 1;
     }
+    public int nextContainerCounter() { // CraftBukkit - void -> int
+        this.field_71139_cq = this.field_71139_cq % 100 + 1;
+        return field_71139_cq; // CraftBukkit
+    }
 
     public void func_180468_a(IInteractionObject p_180468_1_)
     {
@@ -753,7 +785,7 @@
         {
             this.func_71117_bO();
             this.field_71135_a.func_147359_a(new SPacketOpenWindow(this.field_71139_cq, p_180468_1_.func_174875_k(), p_180468_1_.func_145748_c_()));
-            this.field_71070_bA = p_180468_1_.func_174876_a(this.field_71071_by, this);
+            this.field_71070_bA = (CBContainer) p_180468_1_.func_174876_a(this.field_71071_by, this);
             this.field_71070_bA.field_75152_c = this.field_71139_cq;
             this.field_71070_bA.func_75132_a(this);
             net.minecraftforge.common.MinecraftForge.EVENT_BUS.post(new net.minecraftforge.event.entity.player.PlayerContainerEvent.Open(this, this.field_71070_bA));
@@ -988,6 +1020,12 @@
     {
         this.field_71149_ch = -1.0E8F;
     }
+    //CB
+    public void sendMessage(final ITextComponent[] ichatbasecomponent) {
+        for (final ITextComponent component : ichatbasecomponent) {
+            this.func_145747_a(component);
+        }
+    }
 
     public void func_146105_b(ITextComponent p_146105_1_)
     {
@@ -1264,4 +1302,127 @@
         this.func_70052_a(7, true);
         this.func_70052_a(7, false);
     }
+    
+    @Override
+    public CraftPlayer getBukkitEntity() {
+    	return (CraftPlayer) super.getBukkitEntity();
+    }
+    
+    // CraftBukkit start - Add per-player time and weather.
+    public long timeOffset = 0;
+    public boolean relativeTime = true;
+    
+    public long getPlayerTime() {
+    	if (this.relativeTime) {
+    		// Adds timeOffset to the current server time.
+    		return this.field_70170_p.func_72820_D() + this.timeOffset;
+    	} else {
+    		// Adds timeOffset to the beginning of this day.
+    		return this.field_70170_p.func_72820_D() - (this.field_70170_p.func_72820_D() % 24000) + this.timeOffset;
+    	}
+    }
+    
+    public WeatherType weather = null;
+    
+    public WeatherType getPlayerWeather() {
+    	return this.weather;
+    }
+    
+    public void setPlayerWeather(WeatherType type, boolean plugin) {
+    	if (!plugin && this.weather != null) {
+    		return;
+    	}
+    
+    	if (plugin) {
+    		this.weather = type;
+    	}
+    		
+    	if (type == WeatherType.DOWNFALL) {
+    		this.field_71135_a.func_147359_a(new SPacketChangeGameState(2, 0));
+    	} else {
+    		this.field_71135_a.func_147359_a(new SPacketChangeGameState(1, 0));
+    	}
+    }
+    
+    private float pluginRainPosition;
+    private float pluginRainPositionPrevious;
+    
+    public void updateWeather(float oldRain, float newRain, float oldThunder, float newThunder) {
+    	if (this.weather == null) {
+    		// Vanilla
+    		if (oldRain != newRain) {
+    			this.field_71135_a.func_147359_a(new SPacketChangeGameState(7, newRain));
+    		}
+    	} else {
+    		// Plugin
+    		if (pluginRainPositionPrevious != pluginRainPosition) {
+    			this.field_71135_a.func_147359_a(new SPacketChangeGameState(7, pluginRainPosition));
+    		}
+    	}
+    	
+    	if (oldThunder != newThunder) {
+    		if (weather == WeatherType.DOWNFALL || weather == null) {
+    			this.field_71135_a.func_147359_a(new SPacketChangeGameState(8, newThunder));
+    		} else {
+    			this.field_71135_a.func_147359_a(new SPacketChangeGameState(8, 0));
+    		}
+    	}
+    }
+    
+    public void tickWeather() {
+    	if (this.weather == null) return;
+    	
+    	pluginRainPositionPrevious = pluginRainPosition;
+    	if (weather == WeatherType.DOWNFALL) {
+    		pluginRainPosition += 0.01;
+    	} else {
+    		pluginRainPosition -= 0.01;
+    	}
+    	
+    	pluginRainPosition = MathHelper.func_76131_a(pluginRainPosition, 0.0F, 1.0F);
+    }
+    
+    public void resetPlayerWeather() {
+    	this.weather = null;
+    	this.setPlayerWeather(this.field_70170_p.func_72912_H().func_76059_o() ? WeatherType.DOWNFALL : WeatherType.CLEAR, false);
+    }
+    
+    @Override
+    public String toString() {
+    	return super.toString() + "(" + this.func_70005_c_() + " at " + this.field_70165_t + "," + this.field_70163_u + "," + this.field_70161_v + ")";
+    }
+    
+    public void reset() {
+    	float exp = 0;
+    	boolean keepInventory = this.field_70170_p.func_82736_K().func_82766_b("keepInventory");
+    
+    	if (this.keepLevel || keepInventory) {
+    		exp = this.field_71106_cc;
+    		this.newTotalExp = this.field_71067_cb;
+    		this.newLevel = this.field_71068_ca;
+    	}
+    
+    	this.func_70606_j(this.func_110138_aP());
+    	this.field_70720_be = 0;
+    	this.field_70143_R = 0;
+    	//this.foodStats = new FoodStats(this); TODO!!!
+    	this.field_71068_ca = this.newLevel;
+    	this.field_71067_cb = this.newTotalExp;
+    	this.field_71106_cc = 0;
+    	this.field_70725_aQ = 0;
+    	this.func_70674_bp();
+    	//this.updateEffects = true; TODO!!!
+    	this.field_71070_bA = this.field_71069_bz;
+    	this.field_70717_bb = null;
+    	//this.lastDamager = null; TODO!!!
+    	//this.MAIN_HAND = new CombatTracker(this); TODO!!!
+    	this.field_71144_ck = -1;
+    	if (this.keepLevel || keepInventory) {
+    		this.field_71106_cc = exp;
+    	} else {
+    		this.func_71023_q(this.newExp);
+    	}
+    	this.keepLevel = false;
+    }
+    // CraftBukkit end
 }
